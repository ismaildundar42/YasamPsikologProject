@model YasamPsikologProject.WebUi.Models.DTOs.WorkingHourDto
@{
    ViewData["Title"] = "Çalışma Saati Düzenle";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .premium-card {
        border-radius: 15px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        border: none;
    }
    
    .premium-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        padding: 1.5rem 2rem;
        border-radius: 15px 15px 0 0;
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #f093fb;
        box-shadow: 0 0 0 0.2rem rgba(240, 147, 251, 0.25);
    }
    
    .btn-premium {
        border-radius: 10px;
        padding: 0.6rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-premium:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .form-label {
        font-weight: 600;
        color: #344767;
        margin-bottom: 0.5rem;
    }

    .time-slot-checkbox {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .time-slot-checkbox:hover {
        border-color: #f093fb;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);
    }

    .time-slot-checkbox.selected {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-color: #f093fb;
    }

    .time-slot-checkbox.blocked {
        background: #f8d7da;
        border-color: #dc3545;
        opacity: 0.7;
        cursor: not-allowed;
    }

    .time-slot-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <div class="card premium-card">
                <div class="premium-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="text-white mb-0">Çalışma Saati Düzenle</h5>
                            <p class="text-white-50 mb-0 text-sm">Mevcut çalışma saatini güncelleyin</p>
                        </div>
                        <a asp-action="Index" asp-route-psychologistId="@Model.PsychologistId" class="btn btn-white btn-sm">
                            <i class="fas fa-arrow-left me-1"></i> Geri
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i><strong>Hata!</strong> @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-action="Edit" asp-route-id="@Model.Id" method="post">
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.Id)

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Psikolog <span class="text-danger">*</span></label>
                                <select asp-for="PsychologistId" asp-items="ViewBag.Psychologists" class="form-select" required disabled>
                                    <option value="">Psikolog Seçiniz</option>
                                </select>
                                <input type="hidden" asp-for="PsychologistId" />
                                <span asp-validation-for="PsychologistId" class="text-danger text-xs"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Gün <span class="text-danger">*</span></label>
                                <select asp-for="DayOfWeek" asp-items="ViewBag.DaysOfWeek" class="form-select" required>
                                    <option value="">Gün Seçiniz</option>
                                </select>
                                <span asp-validation-for="DayOfWeek" class="text-danger text-xs"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Başlangıç Saati <span class="text-danger">*</span></label>
                                <input asp-for="StartTime" type="time" class="form-control" required />
                                <span asp-validation-for="StartTime" class="text-danger text-xs"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Bitiş Saati <span class="text-danger">*</span></label>
                                <input asp-for="EndTime" type="time" class="form-control" required />
                                <span asp-validation-for="EndTime" class="text-danger text-xs"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Randevular Arası Ara Süresi (dakika)</label>
                                <input asp-for="BufferDuration" type="number" min="0" max="60" step="5" class="form-control" />
                                <small class="text-muted">5'in katları olarak girin (5, 10, 15, 20... dakika) - Varsayılan: 10</small>
                                <span asp-validation-for="BufferDuration" class="text-danger text-xs"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Maksimum Günlük Danışan Sayısı</label>
                                <input asp-for="MaxDailyPatients" type="number" min="1" max="50" class="form-control" placeholder="Boş bırakırsanız sınırsız olur" />
                                <small class="text-muted">Bu günde alınabilecek maksimum danışan sayısı (1-50 arası, boş bırakırsanız sınırsız)</small>
                                <span asp-validation-for="MaxDailyPatients" class="text-danger text-xs"></span>
                            </div>
                        </div>

                        <!-- Molalar -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">Molalar</label>
                                <button type="button" class="btn btn-sm btn-success mb-2" id="addBreakBtn">
                                    <i class="fas fa-plus"></i> Mola Ekle
                                </button>
                                <div id="breakTimesContainer">
                                    @if (Model.BreakTimes != null && Model.BreakTimes.Any())
                                    {
                                        for (int i = 0; i < Model.BreakTimes.Count; i++)
                                        {
                                            <div class="card mb-2 break-time-item" data-index="@i">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-5">
                                                            <label class="form-label">Başlangıç</label>
                                                            <input type="time" name="BreakTimes[@i].StartTime" value="@Model.BreakTimes[i].StartTime.ToString(@"hh\:mm")" class="form-control" required />
                                                            <input type="hidden" name="BreakTimes[@i].Id" value="@Model.BreakTimes[i].Id" />
                                                        </div>
                                                        <div class="col-md-5">
                                                            <label class="form-label">Bitiş</label>
                                                            <input type="time" name="BreakTimes[@i].EndTime" value="@Model.BreakTimes[i].EndTime.ToString(@"hh\:mm")" class="form-control" required />
                                                        </div>
                                                        <div class="col-md-2 text-end">
                                                            <button type="button" class="btn btn-danger btn-sm remove-break-btn" style="margin-top: 25px;">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">Notlar</label>
                                <textarea asp-for="Notes" class="form-control" rows="3" placeholder="İsteğe bağlı notlar..."></textarea>
                                <span asp-validation-for="Notes" class="text-danger text-xs"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="form-check form-switch">
                                    <input asp-for="IsAvailable" class="form-check-input" type="checkbox" />
                                    <label asp-for="IsAvailable" class="form-check-label">Aktif</label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-premium">
                                    <i class="fas fa-save me-2"></i>Güncelle
                                </button>
                                <a asp-action="Index" asp-route-psychologistId="@Model.PsychologistId" class="btn btn-outline-secondary btn-premium">
                                    <i class="fas fa-times me-2"></i>İptal
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Danışan Görünümü Önizleme ve Saat Kapatma -->
            <div class="card premium-card mt-4">
                <div class="premium-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="text-white mb-0">Danışan Görünümü Önizleme</h5>
                            <p class="text-white-50 mb-0 text-sm">Danışanların göreceği randevu saatlerini görüntüleyin ve yönetin</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row mb-3">
                        <div class="col-md-9">
                            <label class="form-label">Önizleme Tarihi</label>
                            <input type="date" id="previewDate" class="form-control" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-info btn-premium w-100" onclick="loadTimeSlotPreview()">
                                <i class="fas fa-eye me-2"></i>Önizle
                            </button>
                        </div>
                    </div>

                    <div id="timeSlotsPreviewContainer" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="slotInfoText">Saatler sistem ayarındaki slot aralığında gösterilmektedir. İstediğiniz slotları seçip kapatabilirsiniz.</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllSlots()">
                                    <i class="fas fa-check-double me-1"></i>Tümünü Seç
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="selectRange()">
                                    <i class="fas fa-grip-lines me-1"></i>Aralık Seç
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllSlots()">
                                    <i class="fas fa-times me-1"></i>Temizle
                                </button>
                            </div>
                            <div>
                                <span id="selectedSlotsCount" class="badge bg-primary">0 saat seçildi</span>
                            </div>
                        </div>

                        <div id="timeSlotsGrid" class="row g-2 mb-3"></div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-danger btn-premium" onclick="blockSelectedSlots()">
                                <i class="fas fa-ban me-2"></i>Seçili Saatleri Kapat
                            </button>
                            <button type="button" class="btn btn-warning btn-premium" onclick="showBlockedSlots()">
                                <i class="fas fa-list me-2"></i>Kapatılmış Saatleri Göster
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        let breakTimeIndex = @(Model.BreakTimes?.Count ?? 0);
        const psychologistId = @Model.PsychologistId;
        let currentPreviewDate = null;
        let currentPreviewDuration = 5; // Varsayılan, sistem ayarından güncellenecek
        let allSlots = [];

        document.getElementById('addBreakBtn').addEventListener('click', function() {
            const container = document.getElementById('breakTimesContainer');
            const breakTimeHtml = `
                <div class="card mb-2 break-time-item" data-index="${breakTimeIndex}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <label class="form-label">Başlangıç</label>
                                <input type="time" name="BreakTimes[${breakTimeIndex}].StartTime" class="form-control" required />
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Bitiş</label>
                                <input type="time" name="BreakTimes[${breakTimeIndex}].EndTime" class="form-control" required />
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-danger btn-sm remove-break-btn" style="margin-top: 25px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', breakTimeHtml);
            breakTimeIndex++;
        });

        document.getElementById('breakTimesContainer').addEventListener('click', function(e) {
            if (e.target.closest('.remove-break-btn')) {
                e.target.closest('.break-time-item').remove();
            }
        });

        // Form submit edilmeden önce validasyon
        document.querySelector('form').addEventListener('submit', function(e) {
            const startTime = document.querySelector('input[name="StartTime"]').value;
            const endTime = document.querySelector('input[name="EndTime"]').value;
            const breakTimes = document.querySelectorAll('.break-time-item');
            
            if (!startTime || !endTime) {
                return true; // Temel validasyon zaten var
            }

            // Mola saatlerini kontrol et
            let hasError = false;
            breakTimes.forEach((breakItem) => {
                const breakStart = breakItem.querySelector('input[name*="StartTime"]').value;
                const breakEnd = breakItem.querySelector('input[name*="EndTime"]').value;
                
                if (breakStart && breakEnd && !hasError) {
                    // Mola başlangıç çalışma başlangıcından önce mi?
                    if (breakStart < startTime) {
                        e.preventDefault();
                        toastr.error(`Mola başlangıç saati (${breakStart}) çalışma başlangıç saatinden (${startTime}) önce olamaz.`);
                        hasError = true;
                        return;
                    }
                    
                    // Mola bitiş çalışma bitişinden sonra mı?
                    if (breakEnd > endTime) {
                        e.preventDefault();
                        toastr.error(`Mola bitiş saati (${breakEnd}) çalışma bitiş saatinden (${endTime}) sonra olamaz.`);
                        hasError = true;
                        return;
                    }
                    
                    // Mola bitiş başlangıçtan önce mi?
                    if (breakStart >= breakEnd) {
                        e.preventDefault();
                        toastr.error(`Mola bitiş saati (${breakEnd}) başlangıç saatinden (${breakStart}) önce veya eşit olamaz.`);
                        hasError = true;
                        return;
                    }
                }
            });
        });

        // Saat slotları önizleme
        async function loadTimeSlotPreview() {
            const dateInput = document.getElementById('previewDate');
            
            if (!dateInput.value) {
                toastr.warning('Lütfen bir tarih seçiniz');
                return;
            }

            currentPreviewDate = dateInput.value;

            // Sistem ayarından SlotInterval'ı al
            try {
                const settingsResponse = await fetch('/Admin/api/SystemSettings/key/SlotInterval');
                if (settingsResponse.ok) {
                    const settingsData = await settingsResponse.json();
                    currentPreviewDuration = parseInt(settingsData.value) || 5;
                }
            } catch (error) {
                console.error('SlotInterval okunamadı, varsayılan 5 kullanılıyor:', error);
                currentPreviewDuration = 5;
            }

            try {
                const url = `/Admin/PublicAppointment/GetAvailableSlots?psychologistId=${psychologistId}&date=${currentPreviewDate}&duration=50`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Veri yüklenirken hata oluştu');
                }
                
                const data = await response.json();
                
                if (data.success && data.slots && data.slots.length > 0) {
                    allSlots = data.slots;
                    renderTimeSlots(data.slots);
                    document.getElementById('timeSlotsPreviewContainer').style.display = 'block';
                } else {
                    toastr.info(data.message || 'Bu tarih için uygun saat bulunmamaktadır.');
                    document.getElementById('timeSlotsPreviewContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading time slots:', error);
                toastr.error('Saat slotları yüklenirken hata oluştu');
            }
        }

        function renderTimeSlots(slots) {
            const container = document.getElementById('timeSlotsGrid');
            container.innerHTML = slots.map(slot => `
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="time-slot-checkbox" onclick="toggleSlotSelection(this)">
                        <div class="d-flex align-items-center justify-content-between">
                            <span class="fw-bold">${slot.time}</span>
                            <input type="checkbox" class="slot-checkbox" data-value="${slot.value}">
                        </div>
                    </div>
                </div>
            `).join('');
            updateSelectedCount();
        }

        function toggleSlotSelection(element) {
            if (element.classList.contains('blocked')) return;
            
            const checkbox = element.querySelector('.slot-checkbox');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
            
            updateSelectedCount();
        }

        function selectAllSlots() {
            document.querySelectorAll('.time-slot-checkbox:not(.blocked)').forEach(slot => {
                slot.classList.add('selected');
                slot.querySelector('.slot-checkbox').checked = true;
            });
            updateSelectedCount();
        }

        function deselectAllSlots() {
            document.querySelectorAll('.time-slot-checkbox').forEach(slot => {
                slot.classList.remove('selected');
                slot.querySelector('.slot-checkbox').checked = false;
            });
            updateSelectedCount();
        }
        function selectRange() {
            const selectedSlots = Array.from(document.querySelectorAll('.slot-checkbox:checked'));
            
            if (selectedSlots.length !== 2) {
                toastr.info('Aralık seçmek için tam 2 slot seçiniz');
                return;
            }

            const allSlots = Array.from(document.querySelectorAll('.time-slot-checkbox:not(.blocked)'));
            const firstIndex = allSlots.findIndex(slot => slot.querySelector('.slot-checkbox') === selectedSlots[0]);
            const secondIndex = allSlots.findIndex(slot => slot.querySelector('.slot-checkbox') === selectedSlots[1]);
            
            const startIndex = Math.min(firstIndex, secondIndex);
            const endIndex = Math.max(firstIndex, secondIndex);
            
            // Aradaki tüm slotları seç
            for (let i = startIndex; i <= endIndex; i++) {
                const slot = allSlots[i];
                slot.classList.add('selected');
                slot.querySelector('.slot-checkbox').checked = true;
            }
            
            updateSelectedCount();
            toastr.success(`${endIndex - startIndex + 1} slot seçildi`);
        }
        function selectRange() {
            const selectedSlots = Array.from(document.querySelectorAll('.slot-checkbox:checked'));
            
            if (selectedSlots.length !== 2) {
                toastr.info('Aralık seçmek için tam 2 slot seçiniz');
                return;
            }

            const allSlots = Array.from(document.querySelectorAll('.time-slot-checkbox:not(.blocked)'));
            const firstIndex = allSlots.findIndex(slot => slot.querySelector('.slot-checkbox') === selectedSlots[0]);
            const secondIndex = allSlots.findIndex(slot => slot.querySelector('.slot-checkbox') === selectedSlots[1]);
            
            const startIndex = Math.min(firstIndex, secondIndex);
            const endIndex = Math.max(firstIndex, secondIndex);
            
            // Aradaki tüm slotları seç
            for (let i = startIndex; i <= endIndex; i++) {
                const slot = allSlots[i];
                slot.classList.add('selected');
                slot.querySelector('.slot-checkbox').checked = true;
            }
            
            updateSelectedCount();
            toastr.success(`${endIndex - startIndex + 1} slot seçildi`);
        }

        function updateSelectedCount() {
            const count = document.querySelectorAll('.slot-checkbox:checked').length;
            document.getElementById('selectedSlotsCount').textContent = `${count} saat seçildi`;
        }

        async function blockSelectedSlots() {
            const selectedCheckboxes = document.querySelectorAll('.slot-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                toastr.warning('Lütfen kapatmak istediğiniz saatleri seçiniz');
                return;
            }

            const selectedSlots = Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
            
            // Onay iste
            const result = await Swal.fire({
                title: 'Saatleri Kapat',
                html: `<strong>${selectedSlots.length}</strong> adet slot kapatılacaktır. Onaylıyor musunuz?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, Kapat',
                cancelButtonText: 'İptal',
                confirmButtonColor: '#dc3545'
            });

            if (!result.isConfirmed) return;

            try {
                // Her slot için ayrı unavailable time oluştur
                let successCount = 0;
                let errorCount = 0;

                for (const slotValue of selectedSlots) {
                    try {
                        const slotDateTime = new Date(slotValue);
                        const endDateTime = new Date(slotDateTime.getTime() + currentPreviewDuration * 60000);

                        // ISO string'i local time olarak format et (UTC conversion olmadan)
                        const formatDateToLocalISO = (date) => {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            const seconds = String(date.getSeconds()).padStart(2, '0');
                            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
                        };

                        const payload = {
                            psychologistId: psychologistId,
                            startDateTime: formatDateToLocalISO(slotDateTime),
                            endDateTime: formatDateToLocalISO(endDateTime),
                            reason: 'Admin tarafından kapatıldı',
                            isAllDay: false,
                            notes: `Toplu kapatma - ${currentPreviewDate}`
                        };

                        console.log('Creating unavailable time:', payload);

                        const response = await fetch('/Admin/UnavailableTimes/Create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();
                        console.log('Response:', result);

                        if (result.success) {
                            successCount++;
                        } else {
                            console.error('Failed to create:', result.message);
                            errorCount++;
                        }
                    } catch (err) {
                        console.error('Error creating slot:', err);
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    toastr.success(`${successCount} saat başarıyla kapatıldı`);
                }
                if (errorCount > 0) {
                    toastr.warning(`${errorCount} saat kapatılamadı`);
                }
                
                // Önizlemeyi yenile
                loadTimeSlotPreview();
            } catch (error) {
                console.error('Error blocking slots:', error);
                toastr.error('Saatler kapatılırken hata oluştu');
            }
        }

        async function showBlockedSlots() {
            if (!currentPreviewDate) {
                toastr.warning('Lütfen önce bir tarih seçip önizle butonuna basınız');
                return;
            }

            try {
                const response = await fetch(`/Admin/UnavailableTimes/GetByPsychologist/${psychologistId}`);
                
                if (!response.ok) {
                    throw new Error('Veri yüklenirken hata oluştu');
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Seçili tarihe ait kapatılmış saatleri filtrele
                    const dateSlots = result.data.filter(item => {
                        const itemDate = new Date(item.startDateTime).toISOString().split('T')[0];
                        return itemDate === currentPreviewDate;
                    });

                    if (dateSlots.length === 0) {
                        Swal.fire('Bilgi', 'Bu tarih için kapatılmış saat bulunmamaktadır.', 'info');
                        return;
                    }

                    const slotsHtml = dateSlots.map(slot => {
                        const start = new Date(slot.startDateTime).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                        const end = new Date(slot.endDateTime).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                        return `
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="checkbox" class="blocked-slot-checkbox" data-id="${slot.id}">
                                    <div>
                                        <strong>${start} - ${end}</strong><br>
                                        <small class="text-muted">${slot.reason}</small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="deleteBlockedSlot(${slot.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }).join('');

                    Swal.fire({
                        title: `Kapatılmış Saatler (${currentPreviewDate})`,
                        html: `
                            <div class="mb-3">
                                <button class="btn btn-sm btn-success me-2" onclick="openAllBlockedSlots()">
                                    <i class="fas fa-check-double me-1"></i>Tümünü Aç
                                </button>
                                <button class="btn btn-sm btn-info" onclick="openSelectedBlockedSlots()">
                                    <i class="fas fa-check me-1"></i>Seçilenleri Aç
                                </button>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto;">${slotsHtml}</div>
                        `,
                        width: 600,
                        showCloseButton: true,
                        showConfirmButton: false
                    });
                }
            } catch (error) {
                console.error('Error loading blocked slots:', error);
                toastr.error('Kapatılmış saatler yüklenirken hata oluştu');
            }
        }

        async function openAllBlockedSlots() {
            const allCheckboxes = document.querySelectorAll('.blocked-slot-checkbox');
            const allIds = Array.from(allCheckboxes).map(cb => cb.dataset.id);
            
            if (allIds.length === 0) return;
            
            const result = await Swal.fire({
                title: 'Tümünü Aç',
                text: `${allIds.length} adet kapatılmış saat açılacak. Onaylıyor musunuz?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, Aç',
                cancelButtonText: 'İptal'
            });
            
            if (!result.isConfirmed) return;
            
            await deleteMultipleSlots(allIds);
        }

        async function openSelectedBlockedSlots() {
            const selectedCheckboxes = document.querySelectorAll('.blocked-slot-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
            
            if (selectedIds.length === 0) {
                toastr.warning('Lütfen açmak istediğiniz saatleri seçiniz');
                return;
            }
            
            const result = await Swal.fire({
                title: 'Seçilenleri Aç',
                text: `${selectedIds.length} adet kapatılmış saat açılacak. Onaylıyor musunuz?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, Aç',
                cancelButtonText: 'İptal'
            });
            
            if (!result.isConfirmed) return;
            
            await deleteMultipleSlots(selectedIds);
        }

        async function deleteMultipleSlots(ids) {
            let successCount = 0;
            let errorCount = 0;
            
            for (const id of ids) {
                try {
                    const response = await fetch(`/Admin/UnavailableTimes/Delete/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Error deleting slot:', error);
                    errorCount++;
                }
            }
            
            if (successCount > 0) {
                toastr.success(`${successCount} saat başarıyla açıldı`);
            }
            if (errorCount > 0) {
                toastr.warning(`${errorCount} saat açılamadı`);
            }
            
            Swal.close();
            showBlockedSlots();
            loadTimeSlotPreview();
        }

        async function deleteBlockedSlot(id) {
            const result = await Swal.fire({
                title: 'Emin misiniz?',
                text: 'Bu saati tekrar açmak istediğinizden emin misiniz?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, Aç',
                cancelButtonText: 'İptal'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(`/Admin/UnavailableTimes/Delete/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('Delete response:', result);

                if (result.success) {
                    toastr.success('Saat başarıyla açıldı');
                    Swal.close(); // Dialog'u kapat
                    showBlockedSlots(); // Listeyi yenile
                    loadTimeSlotPreview(); // Önizlemeyi yenile
                } else {
                    toastr.error('Saat açılırken hata oluştu: ' + (result.message || ''));
                }
            } catch (error) {
                console.error('Error deleting blocked slot:', error);
                toastr.error('Saat açılırken hata oluştu');
            }
        }

        // Sayfa yüklendiğinde bugünün tarihini varsayılan olarak set et
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('previewDate').value = today;
        });
    </script>
}
